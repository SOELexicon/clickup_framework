# Fix for Mermaid Diagram Upload Issue

## Problem

When running:
```bash
cum ca 86c6j3pkb --comment-file mermaid_doc_content.md --upload-images
```

You see errors like:
```
⚠️  Failed to upload e9e36905: Image with hash e9e369055dbd97988c6f... not found in cache
```

## Root Cause

The Mermaid diagrams need to be converted to images and cached BEFORE the upload command runs. The images are generated by Mermaid CLI (mmdc) which requires Chrome/Chromium to render the diagrams.

##  Quick Fix (Windows)

Run the PowerShell script to pre-generate all images:

```powershell
.\generate_mermaid_images_windows.ps1
```

This will:
1. Extract all Mermaid diagrams from `mermaid_doc_content.md`
2. Generate PNG images for each diagram
3. Cache them in `~\.clickup_framework\image_cache\`
4. Create metadata for the upload process

Then run the upload command again:
```bash
cum ca 86c6j3pkb --comment-file mermaid_doc_content.md --upload-images
```

## Quick Fix (Linux/Mac)

Use the Python script:

```bash
python3 generate_mermaid_images.py
```

Then run the upload command.

## Prerequisites

### Mermaid CLI (mmdc)

Install globally with npm:
```bash
npm install -g @mermaid-js/mermaid-cli
```

Verify installation:
```bash
mmdc --version
```

### Chrome/Chromium (for mmdc)

Mermaid CLI uses Puppeteer which requires Chrome. Install Chrome or Chromium browser.

**Linux:**
```bash
# For Ubuntu/Debian
sudo apt-get update
sudo apt-get install chromium-browser

# Or download Chrome:
# https://www.google.com/chrome/
```

**Windows:**
- Download and install Chrome from https://www.google.com/chrome/
- Or Chromium from https://www.chromium.org/

**Mac:**
```bash
# With Homebrew
brew install --cask google-chrome
```

## Manual Generation (Alternative)

If the scripts don't work, you can manually generate images:

### 1. Extract Mermaid Diagrams

Open `mermaid_doc_content.md` and copy each Mermaid code block.

### 2. Use Mermaid Live Editor

Go to https://mermaid.live/ and:
1. Paste your Mermaid code
2. Click "Export" → "PNG"
3. Save the image

### 3. Add to Cache

Calculate the SHA-256 hash of the Mermaid code:
```bash
echo -n "graph LR\n    A --> B" | sha256sum
```

Save the image as `{hash}.png` in:
- Windows: `C:\Users\<YourName>\.clickup_framework\image_cache\`
- Linux/Mac: `~/.clickup_framework/image_cache/`

### 4. Update Metadata

Create or update `metadata.json` in the cache directory:
```json
{
  "e9e369055dbd97988c6f2eb3c65f6c815a1053f89dc533d8f1c9b67ea74ea8f6": {
    "filename": "mermaid_e9e36905.png",
    "extension": ".png",
    "size": 12345,
    "cached_path": "C:\\Users\\...\\e9e369055dbd...png",
    "uploaded": false,
    "upload_url": null,
    "source": "mermaid"
  }
}
```

## Verifying the Fix

Check your cache directory:

**Windows:**
```powershell
dir $env:USERPROFILE\.clickup_framework\image_cache\
```

**Linux/Mac:**
```bash
ls -la ~/.clickup_framework/image_cache/
```

You should see:
- `metadata.json` file
- Multiple `.png` files (one for each diagram)

## Code Improvements (For Developers)

The following improvements were made to support running mmdc as root and in containerized environments:

### 1. Added Puppeteer Configuration Support

Modified `clickup_framework/utils/mermaid_cli.py` to automatically add `--no-sandbox` flag when running as root.

### 2. Chrome Headless Shell Installation

Created `install_chrome_headless.sh` to install Chrome headless shell for Puppeteer in containerized environments.

## Troubleshooting

### "mmdc: command not found"

Install Mermaid CLI:
```bash
npm install -g @mermaid-js/mermaid-cli
```

### "Could not find Chrome"

Install Chrome or Chromium browser (see Prerequisites above).

### "Running as root without --no-sandbox"

This is automatically handled in the updated code. If you still see this error:

1. Update your code with the latest changes
2. Or manually create `puppeteer-config.json`:
```json
{
  "args": ["--no-sandbox", "--disable-setuid-sandbox"]
}
```

Then use:
```bash
mmdc -i diagram.mmd -o diagram.png -p puppeteer-config.json
```

### Images still not uploading

1. Check cache directory exists and has PNG files
2. Verify `metadata.json` exists and is valid JSON
3. Check file permissions
4. Try with `--debug` flag:
```bash
cum ca 86c6j3pkb --comment-file mermaid_doc_content.md --upload-images --debug
```

## Support

For issues or questions:
- GitHub: https://github.com/SOELexicon/clickup_framework/issues
- Documentation: See `docs/MERMAID_DIAGRAMS.md`

---

**Last Updated:** 2025-11-17
