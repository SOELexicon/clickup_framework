name: ClickUp Framework CI/CD

on:
  push:
    branches: [ master, claude/** ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      run_tests:
        description: 'Run full test suite'
        required: false
        default: 'true'
        type: boolean
      run_screenshots:
        description: 'Generate display screenshots'
        required: false
        default: 'false'
        type: boolean

jobs:
  # Job 1: Run tests with coverage
  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    if: |
      github.event_name != 'workflow_dispatch' ||
      (inputs.run_tests == 'true' || inputs.run_tests == true)

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .
        # Verify critical imports work
        python -c "import clickup_framework; import pytest; import yaml; import argcomplete"

    - name: Run API Coverage Report
      run: |
        python tests/run_tests.py --coverage-only

    - name: Run Help Command Tests
      run: |
        python -m pytest tests/test_help_command.py -v --tb=short
      continue-on-error: false

    - name: Run Tests
      env:
        CLICKUP_API_TOKEN: ${{ secrets.CLICKUP_API_TOKEN }}
        TEST_WORKSPACE_ID: "90151898946"
        TEST_SPACE_ID: "90158025753"
        TEST_LIST_ID: ${{ secrets.TEST_LIST_ID }}
        TEST_TASK_ID: ${{ secrets.TEST_TASK_ID }}
      run: |
        python tests/run_tests.py --verbose --coverage

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ github.run_number }}
        path: |
          test_report.json
          test_summary.json
          test_errors.json
          coverage.json
          *.log
        retention-days: 30

    - name: Report Test Failures to ClickUp
      if: false  # DISABLED: Only run if tests failed
      env:
        CLICKUP_API_TOKEN: ${{ secrets.CLICKUP_API_TOKEN }}
        CLICKUP_BUG_LIST_ID: ${{ secrets.CLICKUP_BUG_LIST_ID || '901517412318' }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_REF_NAME: ${{ github.ref_name }}
        GITHUB_SHA: ${{ github.sha }}
        TEST_REPORT_PATH: "test_report.json"
      run: |
        python scripts/report_test_failures_to_clickup.py
      continue-on-error: true  # Don't fail workflow if reporting fails

  # Job 2: Component tests and display screenshots
  display-tests:
    name: ðŸ“¸ Display Component Tests
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' &&
      (inputs.run_screenshots == 'true' || inputs.run_screenshots == true)
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wkhtmltopdf aha

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest pytest-cov

    - name: Run component tests with coverage
      run: |
        python -m pytest tests/components/ -v \
          --cov=clickup_framework.components \
          --cov-report=term \
          --cov-report=html \
          --cov-report=json
      continue-on-error: true

    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-${{ github.run_number }}
        path: |
          htmlcov/
          coverage.json

    - name: Generate display examples
      run: |
        python scripts/generate_display_examples.py
      env:
        FORCE_COLOR: '1'
      continue-on-error: true

    - name: Convert ANSI outputs to screenshots
      run: |
        chmod +x scripts/generate_screenshots.sh
        ./scripts/generate_screenshots.sh
      continue-on-error: true

    - name: Upload screenshots
      uses: actions/upload-artifact@v4
      with:
        name: display-screenshots-${{ github.run_number }}
        path: screenshots/*.jpg
      continue-on-error: true

    - name: Comment PR with screenshots
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          const screenshotDir = 'screenshots';
          if (!fs.existsSync(screenshotDir)) {
            console.log('No screenshots directory found');
            return;
          }

          const screenshots = fs.readdirSync(screenshotDir)
            .filter(f => f.endsWith('.jpg'))
            .map(f => path.join(screenshotDir, f));

          if (screenshots.length === 0) {
            console.log('No screenshots found');
            return;
          }

          let comment = '## ðŸ“¸ Display Component Screenshots\n\n';
          comment += 'The following screenshots show the output of the display components:\n\n';

          for (const screenshot of screenshots) {
            const name = path.basename(screenshot, '.jpg');
            comment += `### ${name.replace(/_/g, ' ')}\n`;
            comment += `![${name}](${screenshot})\n\n`;
          }

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
      continue-on-error: true

  # Job 3: Post workflow results to ClickUp with comprehensive reporting
  post-to-clickup:
    name: ðŸ“Š Report to ClickUp
    runs-on: ubuntu-latest
    needs: [test, display-tests]
    if: false  # DISABLED: Post to ClickUp on master branch failures

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .
        # Verify critical imports work
        python -c "import clickup_framework; import yaml"

    - name: Download test results artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: test-results-*
        merge-multiple: true
      continue-on-error: true

    - name: Download coverage artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: coverage-report-*
        merge-multiple: true
      continue-on-error: true

    - name: Download screenshot artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: display-screenshots-*
        merge-multiple: true
      continue-on-error: true

    - name: List downloaded files
      run: |
        echo "Current directory contents:"
        ls -la
        if [ -f test_report.json ]; then
          echo "âœ“ test_report.json found"
        fi
        if [ -f coverage.json ]; then
          echo "âœ“ coverage.json found"
        fi
        if [ -d screenshots ]; then
          echo "âœ“ screenshots/ directory found"
          ls -la screenshots/
        fi

    - name: Determine job status
      id: status
      run: |
        # Determine overall status based on needed jobs
        if [ "${{ needs.test.result }}" = "failure" ] || [ "${{ needs.display-tests.result }}" = "failure" ]; then
          echo "status=failure" >> $GITHUB_OUTPUT
        elif [ "${{ needs.test.result }}" = "cancelled" ] || [ "${{ needs.display-tests.result }}" = "cancelled" ]; then
          echo "status=cancelled" >> $GITHUB_OUTPUT
        else
          echo "status=success" >> $GITHUB_OUTPUT
        fi

    - name: Post comprehensive workflow report to ClickUp
      env:
        CLICKUP_API_TOKEN: ${{ secrets.CLICKUP_API_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_REF_NAME: ${{ github.ref_name }}
        GITHUB_SHA: ${{ github.sha }}
        JOB_STATUS: ${{ steps.status.outputs.status }}
        GITHUB_WORKFLOW: ${{ github.workflow }}
        GITHUB_RUN_ID: ${{ github.run_id }}
        GITHUB_RUN_NUMBER: ${{ github.run_number }}
        GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
        GITHUB_REF: ${{ github.ref }}
        GITHUB_REF_TYPE: ${{ github.ref_type }}
        GITHUB_ACTOR: ${{ github.actor }}
        GITHUB_TRIGGERING_ACTOR: ${{ github.triggering_actor }}
        GITHUB_EVENT_NAME: ${{ github.event_name }}
        GITHUB_SERVER_URL: ${{ github.server_url }}
      run: |
        python scripts/post_actions_to_clickup.py
      continue-on-error: true
